import { useEffect, useRef} from "react";
import '../css/MusicPlayer.css';
import { useMusic } from "../contexts/MusicContext";

export const MusicPlayer = () => {
  const { currentTrack, 
    formatTime, 
    currentTime, 
    duration, 
    setDuration, 
    setCurrentTime, 
    nextTrack, 
    previousTrack,
    isPlaying,
    pause,
    volume,
    setVolume,
    play } = useMusic();
  const audioRef = useRef(null);

  const handleTimeChange = (e) =>{
    const audio = audioRef.current;
    if(!audio) return;
    const newTime = parseFloat(e.target.value);
    audio.currentTime = newTime;
    setCurrentTime(newTime);

  }

  const handleVolumeChange = (e) =>{
    const newVolume = parseFloat(e.target.value);
    setVolume(newVolume);

  }

  useEffect(() => {

    const audio = audioRef.current;
    if(!audio) return;

    audio.volume = volume;

  }, [volume])

  useEffect(() => {

    const audio = audioRef.current;
    if(!audio) return;

    if(isPlaying){
      audio.play().catch((err) => console.log(err))
    }else{
      audio.pause();
    }

  }, [isPlaying])

  //Va a correr cada que se cambie una cancion
  useEffect(() => {
    const audio = audioRef.current;

    if(!audio) return;

    
    const handleLoadedMetadata = () => {
      setDuration(audio.duration);
    };

    const handleTimeUpdate = () => {
      setCurrentTime(audio.currentTime);
    }

    const handleEnded = () => {
      nextTrack();
    }

    audio.addEventListener("loadedmetadata", handleLoadedMetadata);//loadedmetadata es de JS
    audio.addEventListener("canplay", handleLoadedMetadata);//loadedmetadata es de JS
    audio.addEventListener("timeupdate", handleTimeUpdate);//loadedmetadata es de JS
    audio.addEventListener("ended", handleEnded);//loadedmetadata es de JS


    return () => {
          audio.removeEventListener("loadedmetadata", handleLoadedMetadata);//loadedmetadata es de JS
          audio.removeEventListener("canplay", handleLoadedMetadata);//loadedmetadata es de JS
          audio.removeEventListener("timeupdate", handleTimeUpdate);
          audio.removeEventListener("ended", handleEnded);
    }
  }, [setDuration, setCurrentTime  ,currentTrack , nextTrack]);

  useEffect(() =>{
    const audio = audioRef.current;
    if(!audio) return;

    audio.load();
    setCurrentTime(0);
    setDuration(0);

  }, [currentTrack, setCurrentTime, setDuration]);

  const progressPercentage = duration > 0 ? (currentTime / duration) * 100 : 0;

    if (!currentTrack) return null;
  return (
    <div className="music-player">
      <audio ref={audioRef} src={currentTrack.cancionURL} preload="metadata" /*crossOrigin="anonymous"*//>
       <div className="track-info">
        <h3>
          {currentTrack.nombre}
        </h3>
        <p>
          {currentTrack.artista}
        </p>
       </div>
       <div className="progress-container">
        <span className="time">{formatTime(currentTime)}</span>
        <input type ="range"
         min="0" 
         max={duration || 0} 
         step="0.1" 
        value={currentTime || 0}
        className="progress-bar"
        onChange={handleTimeChange}
        style={{"--progress" : `${progressPercentage}%`}}
        />
        <span className="time">{formatTime(duration)}</span>
       </div>
       <div className="controls">
        <button className="control-btn" onClick={previousTrack}>âª</button>
        <button className="control-btn play-btn" 
        onClick={() => (isPlaying ? pause() : play())}>
          {isPlaying ? "||" : "â–¶"}
        </button>
        <button className="control-btn" onClick={nextTrack}>â­ï¸</button>
       </div>
       <div className="volume-container">
        <span>ğŸ”Š</span>
        <input type="range" min="0" max="1" step="0.1" className="volume-bar"
        onChange={handleVolumeChange}
        value={volume} />
       </div>
    </div>
  )
}

